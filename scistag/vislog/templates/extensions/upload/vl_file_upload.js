let vlUploadUpdateProgress={},vlUploadId={},guidLut=[];for(let e=0;e<256;e++)guidLut[e]=(e<16?"0":"")+e.toString(16);function vlCreateGuid(){var e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,d=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return guidLut[255&e]+guidLut[e>>8&255]+guidLut[e>>16&255]+guidLut[e>>24&255]+"-"+guidLut[255&t]+guidLut[t>>8&255]+"-"+guidLut[t>>16&15|64]+guidLut[t>>24&255]+"-"+guidLut[63&d|128]+guidLut[d>>8&255]+"-"+guidLut[d>>16&255]+guidLut[d>>24&255]+guidLut[255&a]+guidLut[a>>8&255]+guidLut[a>>16&255]+guidLut[a>>24&255]}function vlFileDropAreaInitializeProgress(t,d){let e=document.getElementById(t.id+"_PROGRESS");vlUploadUpdateProgress[t.id]=[],vlUploadId[t.id]=vlCreateGuid(),t.dataset.uploadProgress=[],e.value=0;for(let e=d;0<e;e--)vlUploadUpdateProgress[t.id].push(0)}function vlFileDropAreaUpdateProgress(e,t,d){let a=document.getElementById(e.id+"_PROGRESS");vlUploadUpdateProgress[e.id][t]=d,a.value=vlUploadUpdateProgress[e.id].reduce((e,t)=>e+t,0)/vlUploadUpdateProgress[e.id].length}function vlFileDropAreaHandleFilesForUpload(d,e){e=[...e];var t=d.id+"_GALLERY";document.getElementById(t).innerHTML="";let a=0;e.forEach(function(e,t){a+=e.size});var r=parseInt(d.dataset.max_upload_size),l=parseInt(d.dataset.max_file_count);if(e.length>l)document.getElementById(t).innerHTML="Too many files selected - please select a maximum of "+l+" files";else if(a>=r)document.getElementById(t).innerHTML="Total file size of "+(r/1048576).toFixed(1)+" MB exceeded.";else{vlFileDropAreaInitializeProgress(d,e.length),e.forEach(function(e,t){vlDropAreaUploadFile(d,e,t)});r=vlUploadUpdateProgress[d.id].length;if(parseInt(d.dataset.max_gallery_items)<r&&"1"===d.dataset.show_gallery){let e=document.createElement("div");e.textContent="Too many files - Preview disabled",document.getElementById(t).appendChild(e)}e.forEach(function(e,t){vlDropAreaPreview(d,e,t)})}}function vlDropAreaPreview(e,d){var t=vlUploadUpdateProgress[e.id].length,a=parseInt(e.dataset.max_gallery_items),r=parseInt(e.dataset.max_preview_size);if(!("0"===e.dataset.show_gallery||a<t)){var l=e.id+"_GALLERY",e=d.name.split(".").pop().toLowerCase();if(-1!==["bmp","jpg","jpeg","gif","png"].indexOf(e)){let t=new FileReader;t.readAsDataURL(d),t.onloadend=function(){if(t.result.length>r){let e=document.createElement("div");return e.innerHTML="<br>Image too large<br>",void document.getElementById(l).appendChild(e)}let e=document.createElement("img");e.src=t.result,document.getElementById(l).appendChild(e)}}}}function vlDropAreaUploadFile(t,e,d){let a=new XMLHttpRequest,r=new FormData;a.open("POST","vl_upload_file",!0),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.upload.addEventListener("progress",function(e){vlFileDropAreaUpdateProgress(t,d,100*e.loaded/e.total||100)}),a.addEventListener("readystatechange",function(e){4==a.readyState&&200==a.status?vlFileDropAreaUpdateProgress(t,d,100):4==a.readyState&&a.status}),r.append("widget",t.id),r.append("uploadId",vlUploadId[t.id]),r.append("fileIndex",d),r.append("fileCount",vlUploadUpdateProgress[t.id].length),r.append("file",e),a.send(r)}function vlSetupFileDropArea(t){let d=document.getElementById(t.id+"_DROP_AREA");function a(e){e.preventDefault(),e.stopPropagation()}function r(e){d.classList.add("highlight")}function l(e){d.classList.remove("highlight")}["dragenter","dragover","dragleave","drop"].forEach(e=>{d.addEventListener(e,a,!1),document.body.addEventListener(e,a,!1)}),["dragenter","dragover"].forEach(e=>{d.addEventListener(e,r,!1)}),["dragleave","drop"].forEach(e=>{d.addEventListener(e,l,!1)}),d.addEventListener("drop",function(e){e=e.dataTransfer.files,vlFileDropAreaHandleFilesForUpload(t,e)},!1)}